<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Jeu des Émotions avec Suivi du Regard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
</head>
<body>
  <div class="container">
    <h1>Jeu des Émotions</h1>
    <p>Suivez le regard et identifiez l'émotion sur le visage affiché.</p>

    <div class="image-container">
      <img id="face-image" src="media/people/allya.png" alt="Image de visage">
    </div>

    <div class="emotion-buttons">
      <button onclick="selectEmotion('joie')">Joie</button>
      <button onclick="selectEmotion('tristesse')">Tristesse</button>
      <button onclick="selectEmotion('colère')">Colère</button>
      <button onclick="selectEmotion('surprise')">Surprise</button>
    </div>

    <p id="result"></p>
  </div>

  <script>
    let gazeData = [];

    function isGazeInsideImage(data) {
      const imageElement = document.getElementById('face-image');
      const imageRect = imageElement.getBoundingClientRect();

      return (
        data.x >= imageRect.left &&
        data.x <= imageRect.right &&
        data.y >= imageRect.top &&
        data.y <= imageRect.bottom
      );
    }

    function downloadGazeData() {
      const json = JSON.stringify(gazeData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });

      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'EmotionalGameData.json';
      a.click();

      URL.revokeObjectURL(a.href);
    }

    webgazer.setGazeListener((data, clock) => {
      if (data && isGazeInsideImage(data)) {
        const currentImage = document.getElementById('face-image').src;
        gazeData.push({ x: data.x, y: data.y, time: clock, image: currentImage });
      }
    }).begin();

    const images = [
      { src: "media/people/allya.png", emotion: "joie" },
      { src: "media/people/teem.png", emotion: "tristesse" },
      { src: "media/people/jeanne.png", emotion: "colère" },
      { src: "media/people/pierre.png", emotion: "surprise" }
    ];

    let currentIndex = 0;

    function selectEmotion(emotion) {
      const correctEmotion = images[currentIndex].emotion; 
      const resultText = document.getElementById("result");

      if (emotion === correctEmotion) {
        resultText.textContent = "Bonne réponse!";
        resultText.style.color = "green";
      } else {
        resultText.textContent = "Mauvaise réponse.";
        resultText.style.color = "red";
      }

      currentIndex++;
      if (currentIndex < images.length) {
        setTimeout(() => {
          document.getElementById("face-image").src = images[currentIndex].src;
          resultText.textContent = "";
        }, 1000);
      } else {
        resultText.textContent = "Jeu terminé";
        downloadGazeData();
      }
    }
  </script>
</body>
</html>
