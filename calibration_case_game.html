<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGazer Demo</title>
    <link rel="stylesheet" type="text/css" href="./style.css">
    <script src="./webgazer.js"></script>
    <link rel="stylesheet" href="./bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
        integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Play:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
            justify-content: center;
            align-items: center;
            right: 100%;
            left: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(7, 100px);
            grid-auto-rows: 100px;
            gap: 5px;
            background-color: rgb(255, 255, 255);
        }

        .case {
            width: 100%;
            height: 100%;
            border: 1px solid black;
            background-color: #f0f0f0;
        }

        .green {
            background-color: green;
        }

        .counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .stage {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        #gameContainer {
            display: none;
            position: relative;
            z-index: 1;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: auto;
            justify-content: center;
            align-items: center;
            right: 15%;
            background-color: #f0f0f0;
        }

    </style>
</head>
<body>
    <canvas id="plotting_canvas" width="500" height="500" style="cursor:crosshair;"></canvas>
    
    <nav id="webgazerNavbar" class="navbar navbar-expand-lg navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#myNavbar">
                    <span class="navbar-toggler-icon">Menu</span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li id="Accuracy"><a>Not yet Calibrated</a></li>
                    <li><a onclick="Restart()" href="#" class="liens">Recalibrate</a></li>
                    <li><a onclick="showGame()" href="#" class="liens">Play</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a class="helpBtn" onclick="helpModalShow()" href="#"><span
                                class="glyphicon glyphicon-cog"></span> Help</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="jeu"></div>

    <div class="calibrationDiv">
        <input type="button" class="Calibration" id="Pt1">
        <input type="button" class="Calibration" id="Pt2">
        <input type="button" class="Calibration" id="Pt3">
        <input type="button" class="Calibration" id="Pt4">
        <input type="button" class="Calibration" id="Pt5">
        <input type="button" class="Calibration" id="Pt6">
        <input type="button" class="Calibration" id="Pt7">
        <input type="button" class="Calibration" id="Pt8">
        <input type="button" class="Calibration" id="Pt9">
        <input type="button" class="Calibration" id="Pt10">
        <input type="button" class="Calibration" id="Pt11">
        <input type="button" class="Calibration" id="Pt12">
        <input type="button" class="Calibration" id="Pt13">
        <input type="button" class="Calibration" id="Pt14">
        <input type="button" class="Calibration" id="Pt15">
        <input type="button" class="Calibration" id="Pt16">
        <input type="button" class="Calibration" id="Pt17">
    </div>

    <div id="helpModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <img src="media/example/calibration.png" width="100%" height="100%"
                        alt="webgazer demo instructions">
                </div>
                <div class="modal-footer">
                    <button id="closeBtn" type="button" class="btn btn-default" data-dismiss="modal">Close & load
                        saved model</button>
                    <button type="button" id='start_calibration' class="btn btn-primary" data-dismiss="modal"
                        onclick="Restart()">Calibrate</button>
                </div>
            </div>
        </div>
    </div>

    <div style="background: rgb(0, 0, 0); opacity: 0.85; width: 100%; height: 100%; position: fixed; z-index: 2147483647; top: 0px; display: none;"
        id="WebGLMobileInputSystemUI">
        <form
            style="position: absolute;top: 30%;display: flex;width: 100%;justify-content: center;z-index: 2147483647;opacity: 1;"
            id="form1">
            <input type="text" id="inputField" style="display: block;font-size: 175%;" placeholder="enter here"
                size="35">
            <input type="submit" value="DONE" style="display: block;margin-left: 0.4%;font-size: 175%;" id="doneButton">
            <input value="CANCEL" id="cancelButton" type="button"
                style="margin-left: 0.4%;display: block;font-size: 175%;" onclick="cancel();">
        </form>
    </div>

    <div id="gameContainer">
        <div class="counter">Essais restants: 20</div>
        <div class="stage">Étape: 1</div>
        <div class="grid"></div>
    </div>

    <script src="../node_modules/sweetalert/dist/sweetalert.min.js"></script>
    <script src="./main.js"></script>
    <script src="./calibration.js"></script>
    <script src="./gaze_recording.js"></script>
    <script src="./precision_calculation.js"></script>
    <script src="./precision_store_points.js"></script>
    <script src="./resize_canvas.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bowser@2.11.0/es5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<script>
    var stage = 1;
    var attempts = 20;
    var interval;
    var previousCases = [];
    var dataLog = [];
    var gazeData = [];
    var combinedData = [];

    webgazer.setGazeListener(function (data, elapsedTime) {
        if (data == null) {
            return;
        }
        var x = data.x; // gaze x coordinate
        var y = data.y; // gaze y coordinate
        gazeData.push({ x, y, timestamp: elapsedTime });
    }).begin();

    function initGame() {
        createGrid();
        updateStageIndicator();
        startStage(stage);
    }

    function createGrid() {
        var grid = document.querySelector('.grid');
        grid.innerHTML = '';
        for (var i = 0; i < 49; i++) {
            var caseDiv = document.createElement('div');
            caseDiv.classList.add('case');
            caseDiv.id = 'case' + i;
            grid.appendChild(caseDiv);
        }
        attempts = 20;
        previousCases = [];
        updateCounter();
    }

    function startStage(currentStage) {
        clearInterval(interval);
        interval = setInterval(() => {
            previousCases.forEach((caseDiv) => {
                caseDiv.classList.remove('green');
            });
            previousCases = [];

            var indexes = getRandomIndexes(currentStage);

            indexes.forEach((index) => {
                var currentCase = document.getElementById('case' + index);
                currentCase.classList.add('green');
                previousCases.push(currentCase);
            });

            logData("cases_lighted", { stage: currentStage, cases: indexes });

            setTimeout(() => {
                previousCases.forEach((caseDiv) => {
                    caseDiv.classList.remove('green');
                });
            }, 1000);
            attempts--;
            updateCounter();

            if (attempts <= 0) {
                clearInterval(interval);
                if (currentStage < 3) {
                    stage++;
                    createGrid();
                    updateStageIndicator();
                    startStage(stage);
                } else {
                    // Game finished
                    alert("Jeu terminé!");
                    showFinishButton(); // Show the button to go to another page
                    downloadGameData();
                }
            }
        }, 3000);
    }

    function showFinishButton() {
        var gameContainer = document.getElementById('gameContainer');
        var finishButton = document.createElement('button');
        finishButton.textContent = 'Passer à une autre page';
        finishButton.classList.add('btn', 'btn-primary', 'mt-3');
        finishButton.onclick = function() {
            window.location.href = 'calibration_emotional_game.html';
        };
        gameContainer.appendChild(finishButton);
    }

    function logData(event, details) {
        combinedData.push({
            event,
            details,
            gazeData: [...gazeData], // Add a snapshot of the current gaze data
            timestamp: new Date().toISOString()
        });
        gazeData = []; // Clear the gaze data for the next interval
        console.log("Données enregistrées:", combinedData);
    }

    function updateCounter() {
        document.querySelector('.counter').textContent = `Essais restants: ${attempts}`;
    }

    function updateStageIndicator() {
        document.querySelector('.stage').textContent = `Étape: ${stage}`;
    }

    function getRandomIndexes(currentStage) {
        var indexes = [];
        if (currentStage === 1) {
            var randomIndex = Math.floor(Math.random() * 49);
            indexes.push(randomIndex);
        } else if (currentStage === 2) {
            var validIndexes = [];
            for (var i = 0; i < 42; i++) {
                if (i % 7 < 6) validIndexes.push(i);
            }
            var randomStart = validIndexes[Math.floor(Math.random() * validIndexes.length)];
            indexes = [
                randomStart,
                randomStart + 1,
                randomStart + 7,
                randomStart + 8
            ];
        } else if (currentStage === 3) {
            var validIndexes = [];
            for (var i = 0; i < 35; i++) {
                if (i % 7 < 5) validIndexes.push(i);
            }
            var randomStart = validIndexes[Math.floor(Math.random() * validIndexes.length)];
            indexes = [
                randomStart,
                randomStart + 1, randomStart + 2,
                randomStart + 7, randomStart + 8, randomStart + 9,
                randomStart + 14, randomStart + 15, randomStart + 16
            ];
        }
        return indexes;
    }

    function showGame() {
        document.getElementById("gameContainer").style.display = "block";
        initGame();
    }

    function downloadGameData() {
        combinedData.forEach(record => {
            record.gazeData.forEach(gaze => {
                record.details.cases.forEach(caseIndex => {
                    var caseElement = document.getElementById('case' + caseIndex);
                    var caseRect = caseElement.getBoundingClientRect();
                    var caseViewed = (
                        gaze.x >= caseRect.left &&
                        gaze.x <= caseRect.right &&
                        gaze.y >= caseRect.top &&
                        gaze.y <= caseRect.bottom
                    );
                    gaze.caseIndex = caseIndex;
                    gaze.stage = record.details.stage;
                    gaze.caseViewed = caseViewed;
                });
            });
        });

        var blob = new Blob([JSON.stringify(combinedData, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'CaseGame.json';
        document.body.appendChild(a); // Append the anchor element to the body and trigger a click event
        a.click();
        document.body.removeChild(a); // Clean up: remove the anchor element and revoke the URL object
        URL.revokeObjectURL(url);
    }
    // Ensure webgazer is started and the game is shown on window load
    window.onload = function () {
        webgazer.begin();
    }
</script>

</body>
</html>

